import streamlit as st
import pandas as pd
import numpy as np
import os
import matplotlib.pyplot as plt

from factor_analyzer import FactorAnalyzer
from sklearn.preprocessing import StandardScaler

import networkx as nx

st.set_page_config(page_title="Q-Method", layout="wide")
st.title("ë°ì´í„°ì„¼í„° ì§€ì†ê°€ëŠ¥ì„± ì¸ì‹ ì¡°ì‚¬")

with st.expander("ğŸ“˜ ì¡°ì‚¬ ê°œìš”", expanded=True):
    st.markdown("""
        ë³¸ ì¡°ì‚¬ëŠ” ë°ì´í„°ì„¼í„°ì˜ ê¸°ìˆ Â·ì…ì§€Â·ì‚¬ëŒÂ·ê±°ë²„ë„ŒìŠ¤ì— ëŒ€í•œ ì‚¬íšŒì  ìˆ˜ìš©ì„±ê³¼ ê´€ë ¨ëœ ë‹¤ì–‘í•œ ì§„ìˆ ë¬¸ì— ëŒ€í•´, ê·€í•˜ì˜ ì¸ì‹ì„ íŒŒì•…í•˜ê³ ì í•©ë‹ˆë‹¤. 
        í•œêµ­ê³µí•™ëŒ€í•™êµ ì£¼ê´€ í•™ìˆ  ì—°êµ¬ ëª©ì ìœ¼ë¡œ ìˆ˜í–‰ë˜ëŠ” ë³¸ ì¡°ì‚¬ëŠ” ì¡°ì‚¬ì§€ ìì²´ì˜ ìµëª…ì„±ì´ ìœ ì§€ë˜ë©° ì‘ë‹µì ê³ ìœ ì„±ì„ í™•ì¸í•˜ê¸° ìœ„í•´ ì´ë©”ì¼ì„ ìˆ˜ì§‘ í›„ íŒŒê¸°í•©ë‹ˆë‹¤. 
        ëª¨ë“  ì„¹ì…˜ì— ì°¸ì—¬í•˜ì‹œëŠ” ë° 10ë¶„ ì´ë‚´ë¡œ ì†Œìš”ë˜ë©°, ì°¸ì—¬í•´ì£¼ì‹  ë¶„ê»˜ëŠ” ì•½ì†Œí•˜ì˜¤ë‚˜ ì†Œì¤‘í•œ ì‹œê°„ì„ ë‚´ì–´ì£¼ì‹  ë° ëŒ€í•œ ê°ì‚¬ì˜ ì˜ë¯¸ë¡œ ìë¬¸ ìˆ˜ë‹¹(10ë§Œì›, ì„¸ì „)ì„ ë³„ë„ë¡œ ì†¡ê¸ˆí•´ ë“œë¦½ë‹ˆë‹¤.
        ë°ì´í„°ì„¼í„°ëŠ” ì¸ê³µì§€ëŠ¥, í´ë¼ìš°ë“œ, ë””ì§€í„¸ ì‚°ì—… ë°œì „ì„ ê°€ëŠ¥í•˜ê²Œ í•˜ëŠ” í•µì‹¬ ê¸°ë°˜ ì‹œì„¤ì…ë‹ˆë‹¤. í•˜ì§€ë§Œ ê·¸ì™€ ë™ì‹œì— ë§‰ëŒ€í•œ ì „ë ¥ì„ ì†Œë¹„í•˜ê³ , ë¬¼ì„ ë§ì´ ì‚¬ìš©í•˜ë©°, ì…ì§€ ì„ ì • ê³¼ì •ì—ì„œ ì‹œë¯¼ë“¤ê³¼ ê°ˆë“±ì„ ë¹šê¸°ë„ í•©ë‹ˆë‹¤.
        ë™ ì—°êµ¬ì—ì„œëŠ”
        - ì‹œë¯¼ë“¤ì€ ë°ì´í„°ì„¼í„°ì— ëŒ€í•´ ì–´ë–¤ ìƒê°ì„ ê°€ì§€ê³  ìˆì„ê¹Œ? ê·¸
        - ë¦¬ê³  ê·¸ íŒë‹¨ì€ ì–´ë–¤ ê°€ì¹˜ë‚˜ ìš°ì„ ìˆœìœ„ì— ë”°ë¼ ë‹¬ë¼ì§ˆê¹Œ? ë¥¼ ì•Œì•„ë³´ê¸° ìœ„í•œ ëª©ì ì„ ê°€ì§€ê³  ì„¤ë¬¸ì¡°ì‚¬ë¥¼ ì‹œí–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤.
        ì„¤ë¬¸ì€ ì´ 24ê°œì˜ ë¬¸ì¥ì„ ì œì‹œí•˜ë©°, ì´ ë¬¸ì¥ë“¤ì€ ì‚¬ëŒë“¤ì´ ë°ì´í„°ì„¼í„°ì— ëŒ€í•´ í”íˆ í•˜ëŠ” ì£¼ì¥ì´ë‚˜ ì˜ê²¬ì„ ì •ë¦¬í•œ ê²ƒì…ë‹ˆë‹¤.
        """)
with st.expander("ğŸ§© ì„¹ì…˜ ì„¤ëª…", expanded=True):
    st.markdown("""
    ì„¤ë¬¸ì€ ë¦¬ì»¤íŠ¸ ë°©ì‹ìœ¼ë¡œ ì§„í–‰ë˜ë©°, ì œì‹œëœ 24ê°œ ë¬¸ì¥ì„ â€œë‚˜ëŠ” ì´ ìƒê°ì— ì–¼ë§ˆë‚˜ ë™ì˜í•˜ëŠ”ê°€?â€ì˜ ê¸°ì¤€ìœ¼ë¡œ ì…ë ¥í•˜ì‹œë˜, ë§¤ìš° ë™ì˜í•˜ê±°ë‚˜ ë™ì˜í•˜ì§€ ì•ŠëŠ” ë¬¸ì¥ì€ ì´ 1-3ë¬¸ì¥ ì´ë‚´ë¡œ í•˜ì‹œê³ , ì¤‘ë¦½ì ì´ê±°ë‚˜ íŒë‹¨ì„ ìœ ë³´í•˜ì‹œê³  ì‹¶ì€ ë¬¸ì¥ì€ ë³´í†µì´ë‹¤ë¡œ ì„ íƒí•´ì£¼ì„¸ìš”.
    ë¬¸ì¥ë“¤ì€ ë‹¤ìŒ ë„¤ ê°œì˜ ê´€ì ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤:
      1) ê¸°ìˆ (Technology): ì´ ì˜ì—­ì€ ë°ì´í„°ì„¼í„°ê°€ ì–´ë–¤ ê¸°ìˆ ì„ ì‚¬ìš©í•˜ëŠ”ì§€ë¥¼ ì‹œë¯¼ë“¤ì´ ì–´ë–»ê²Œ ë°”ë¼ë³´ëŠ”ì§€ë¥¼ ë‹¤ë£¹ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ì¬ìƒì—ë„ˆì§€ ì‚¬ìš© ì—¬ë¶€, ì¹œí™˜ê²½ ëƒ‰ê° ê¸°ìˆ , ë°±ì—… ì „ë ¥ ë°©ì‹, ê¸°ìˆ ì˜ ì•ˆì „ì„±ê³¼ ê±°ë¦¬ê° ë“±ì´ ì—¬ê¸°ì— í¬í•¨ë©ë‹ˆë‹¤. ë‹¹ì‹ ì€ ê¸°ìˆ ì˜ ì¢…ë¥˜ë‚˜ ë°©ì‹ì´ ì‹œë¯¼ì˜ ì‹ ë¢°ë‚˜ ìˆ˜ìš©ì„±ì— ì–´ë–¤ ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆë‹¤ê³  ìƒê°í•˜ì‹­ë‹ˆê¹Œ?
      2) ì‚¬ëŒ (People): ì´ ì˜ì—­ì€ ë°ì´í„°ì„¼í„°ë¥¼ ë‘˜ëŸ¬ì‹¼ ì‚¬ëŒë“¤ ê°„ì˜ ê´€ê³„ì™€ ì‹ ë¢°, ì°¸ì—¬ì˜ ë°©ì‹ì— ê´€í•œ ì‹œë¯¼ë“¤ì˜ ì¸ì‹ì„ ë‹¤ë£¹ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ì‹œë¯¼ ì˜ê²¬ì´ ë°˜ì˜ë˜ì—ˆëŠ”ì§€, ì„¤ëª…íšŒê°€ í˜•ì‹ì ì´ì§€ ì•Šì•˜ëŠ”ì§€, ì •ë¶€ì™€ ê¸°ì—… ì¤‘ ëˆ„ê°€ ë” ì‹ ë¢°ë°›ëŠ”ì§€ ë“±ì´ í¬í•¨ë©ë‹ˆë‹¤. ë°ì´í„°ì„¼í„°ì™€ ê´€ë ¨ëœ ë‹¤ì–‘í•œ ì´í•´ê´€ê³„ìë“¤ ì‚¬ì´ì˜ ì‹ ë¢°ì™€ ê´€ê³„ê°€, ì‹œë¯¼ë“¤ì˜ ìˆ˜ìš©ì„± íŒë‹¨ì— ì–´ë–¤ ì˜í–¥ì„ ì¤€ë‹¤ê³  ìƒê°í•˜ì‹­ë‹ˆê¹Œ?
      3) ì¥ì†Œ (Place): ì´ ì˜ì—­ì€ ë°ì´í„°ì„¼í„°ê°€ ì–´ë””ì— ë“¤ì–´ì„œëŠëƒì— ë”°ë¼ ì‹œë¯¼ë“¤ì´ ì–´ë–»ê²Œ ë°˜ì‘í•˜ëŠ”ì§€ë¥¼ ë‹¤ë£¹ë‹ˆë‹¤. ê¸°ì¡´ ì‚°ì—… ë¶€ì§€ì˜ í™œìš©, ì§€ì—­ ì •ì²´ì„±ê³¼ì˜ ì¡°í™”, ìì—°í™˜ê²½ í›¼ì†, ìˆ˜ë„ê¶Œ/ì§€ë°© ì°¨ì´, ì™¸ë¶€ ìë³¸ ì£¼ë„ì˜ ë¶ˆì‹  ê°€ëŠ¥ì„± ë“±ì´ í¬í•¨ë©ë‹ˆë‹¤. ë‹¹ì‹ ì€ ì…ì§€ì˜ íŠ¹ì„±ê³¼ ë§¥ë½ì´ ì‹œë¯¼ ìˆ˜ìš©ì„±ì— ì–´ë–¤ ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆë‹¤ê³  ìƒê°í•˜ì‹­ë‹ˆê¹Œ?
      4) ê³¼ì • (Process): ì´ ì˜ì—­ì€ ë°ì´í„°ì„¼í„°ê°€ ì–´ë–¤ ì ˆì°¨ì™€ ë°©ì‹ìœ¼ë¡œ ê²°ì •Â·ìš´ì˜ë˜ì—ˆëŠ”ì§€ë¥¼ ì‹œë¯¼ë“¤ì´ ì–´ë–»ê²Œ í‰ê°€í•˜ëŠ”ì§€ë¥¼ ë‹¤ë£¹ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ì •ë³´ ê³µê°œ ì‹œì , í™˜ê²½ì˜í–¥í‰ê°€ì˜ ì‹ ë¢°ë„, ê¸°ì—…â€“ì§€ìì²´ í˜‘ë ¥ ì—¬ë¶€, ì‚¬í›„ ëª¨ë‹ˆí„°ë§ì˜ ìœ ë¬´ ë“±ì´ í¬í•¨ë©ë‹ˆë‹¤. ë‹¹ì‹ ì€ ê²°ì • ê³¼ì •ì˜ íˆ¬ëª…ì„±ê³¼ ì°¸ì—¬ ë°©ì‹ì´ ì‹œë¯¼ì˜ ì‹ ë¢°ì™€ ìˆ˜ìš©ì— ì–´ë–¤ ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆë‹¤ê³  ìƒê°í•˜ì‹­ë‹ˆê¹Œ?
    """)

DATA_PATH = "responses.csv"

tabs = st.tabs(["âœï¸ ì„¤ë¬¸ ì‘ë‹µ", "ğŸ“ˆ ìš”ì¸ ë¶„ì„", "ğŸ” í”¼ë“œë°± êµ¬ì¡°"])

statements = [
    "ë°ì´í„°ì„¼í„°ëŠ” ì¬ìƒì—ë„ˆì§€ë¥¼ ì‚¬ìš©í•  ë•Œ í™˜ê²½ ì±…ì„ì„±ì„ ê°–ì¶˜ ì‹œì„¤ë¡œ í‰ê°€ë°›ì„ ìˆ˜ ìˆë‹¤.",
    "ë””ì ¤ì´ë‚˜ ê°€ìŠ¤ ë°œì „ê¸°ë¥¼ ë°±ì—… ì „ë ¥ìœ¼ë¡œ ì‚¬ìš©í•  ê²½ìš° í™˜ê²½ì  ìš°ë ¤ê°€ ì œê¸°ë  ìˆ˜ ìˆë‹¤.",
    "ë¬¼ ì ˆì•½ì´ë‚˜ ì¹œí™˜ê²½ ëƒ‰ê° ê¸°ìˆ ì˜ ë„ì…ì€ ì‹œë¯¼ ì‹ ë¢°ì— ê¸ì •ì  ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆë‹¤.",
    "ê¸°ìˆ ì´ ìµœì‹ ì´ë”ë¼ë„ ì•ˆì „ì„± í™•ë³´ê°€ ë¶€ì¡±í•˜ë©´ ì‹œë¯¼ ë¶ˆì•ˆì„ ìœ ë°œí•  ìˆ˜ ìˆë‹¤.",
    "ë°ì´í„°ì„¼í„° ê¸°ìˆ ì€ ë¹„ìš© íš¨ìœ¨ì„±ë³´ë‹¤ëŠ” ì‚¬íšŒì  ì±…ì„ì„ ìš°ì„ ì‹œí•´ì•¼ í•œë‹¤ëŠ” ê²¬í•´ê°€ ìˆë‹¤.",
    "ê¸°ìˆ ì´ ë‚¯ì„¤ê±°ë‚˜ ë³µì¡í•˜ê²Œ ì¸ì‹ë˜ë©´ ì‹œë¯¼ê³¼ì˜ ê±°ë¦¬ê°ì´ ì»¤ì§ˆ ìˆ˜ ìˆë‹¤.",
    "ë°ì´í„°ì„¼í„° ê±´ì„¤ ê³¼ì •ì— ì‹œë¯¼ ì˜ê²¬ì´ ë°˜ì˜ë˜ì§€ ì•Šìœ¼ë©´ ë°˜ë°œ ê°€ëŠ¥ì„±ì´ ë†’ì•„ì§ˆ ìˆ˜ ìˆë‹¤.",
    "ì§€ì—­ ì‚¬íšŒì™€ ì¥ê¸°ì  ê´€ê³„ë¥¼ ë§ºì–´ì˜¨ ê¸°ì—…ì€ ë” ë†’ì€ ì‹ ë¢°ë¥¼ ë°›ì„ ìˆ˜ ìˆë‹¤.",
    "ì„¤ëª…íšŒê°€ í˜•ì‹ì ìœ¼ë¡œ ë³´ì¼ ê²½ìš°, ì‹œë¯¼ ë¶ˆì‹ ì„ ìœ ë°œí•  ìˆ˜ ìˆë‹¤.",
    "ì •ë³´ ì ‘ê·¼ì„±ì´ ë‚®ì„ìˆ˜ë¡ ì‹œë¯¼ì˜ ë¶ˆì•ˆê³¼ ì˜ì‹¬ì´ ì¦ê°€í•  ìˆ˜ ìˆë‹¤.",
    "ê°ˆë“± ìƒí™©ì—ì„œëŠ” ì¤‘ë¦½ì  ì œ3ìì˜ ê°œì…ì´ ì¡°ì •ì— ë„ì›€ì´ ë  ìˆ˜ ìˆë‹¤.",
    "ë™ì¼í•œ ì„¤ëª…ì´ë¼ë„ ì •ë¶€ê°€ ì „ë‹¬í•  ê²½ìš° ê¸°ì—…ë³´ë‹¤ ë” ì‹ ë¢°ë°›ì„ ê°€ëŠ¥ì„±ì´ ìˆë‹¤.",
    "ê¸°ì¡´ ê³µì¥ì´ë‚˜ ë°œì „ì†Œ ë¶€ì§€ë¥¼ ì¬í™œìš©í•œ ë°ì´í„°ì„¼í„°ëŠ” ìˆ˜ìš©ì„±ì´ ë†’ì•„ì§ˆ ìˆ˜ ìˆë‹¤.",
    "ì§€ì—­ ì •ì²´ì„±ê³¼ ì¡°í™”ë¥¼ ì´ë£¨ì§€ ëª»í•˜ëŠ” ì…ì§€ëŠ” ê±°ë¶€ê°ì„ ìœ ë°œí•  ìˆ˜ ìˆë‹¤.",
    "ìì—°ê²½ê´€ í›¼ì†ì´ ë°œìƒí•˜ëŠ” ê²½ìš°, ê¸°ìˆ  ìš°ìˆ˜ì„±ë§Œìœ¼ë¡œ ìˆ˜ìš©ì„± í™•ë³´ëŠ” ì–´ë ¤ìš¸ ìˆ˜ ìˆë‹¤.",
    "ìˆ˜ë„ê¶Œê³¼ ì§€ë°©ì€ ë°ì´í„°ì„¼í„° ì…ì§€ì— ëŒ€í•´ ì„œë¡œ ë‹¤ë¥¸ ê¸°ì¤€ì„ ê°€ì§ˆ ìˆ˜ ìˆë‹¤.",
    "ì™¸ë¶€ ìë³¸ ì£¼ë„ì˜ ì¼ë°©ì ì¸ ì…ì§€ ê²°ì •ì€ ì§€ì—­ì‚¬íšŒì˜ ì‹ ë¢°ë¥¼ ì €í•´í•  ìˆ˜ ìˆë‹¤.",
    "ì§€ì—­ì— ì‹¤ì§ˆì ì¸ í˜œíƒì´ ì œê³µë˜ë©´ ì‹œë¯¼ ìˆ˜ìš©ì„±ì´ ë†’ì•„ì§ˆ ìˆ˜ ìˆë‹¤.",
    "ì´ˆê¸° ë‹¨ê³„ì—ì„œ ì •ë³´ê°€ íˆ¬ëª…í•˜ê²Œ ê³µê°œë˜ë©´ ì‹œë¯¼ ì‹ ë¢°ê°€ ë†’ì•„ì§ˆ ìˆ˜ ìˆë‹¤.",
    "í™˜ê²½ì˜í–¥í‰ê°€ ê²°ê³¼ëŠ” ì‹œë¯¼ë“¤ì˜ ìˆ˜ìš© ì—¬ë¶€ì— ì¤‘ìš”í•œ íŒë‹¨ ê¸°ì¤€ì´ ë  ìˆ˜ ìˆë‹¤.",
    "ê¸°ì—…ê³¼ ì§€ìì²´ê°€ ê³µë™ìœ¼ë¡œ ê²°ì •í•œ í”„ë¡œì íŠ¸ëŠ” ë” ë†’ì€ ì‹ ë¢°ë¥¼ ì–»ì„ ìˆ˜ ìˆë‹¤.",
    "ë²•ì  ìš”ê±´ì„ ì¶©ì¡±í•˜ë”ë¼ë„ ì‹œë¯¼ ì‹ ë¢°ë¥¼ í™•ë³´í•˜ë ¤ë©´ ì¶”ê°€ì ì¸ ì„¤ëª…ì´ í•„ìš”í•  ìˆ˜ ìˆë‹¤.",
    "ì§€ì—­ ì–¸ë¡ ì´ ì‹ ì†í•˜ê³  ì •í™•í•˜ê²Œ ì •ë³´ë¥¼ ì „ë‹¬í•˜ë©´ ì‹ ë¢°ì„± ì œê³ ì— ê¸°ì—¬í•  ìˆ˜ ìˆë‹¤.",
    "ë°ì´í„°ì„¼í„° ì™„ê³µ ì´í›„ì—ë„ ëª¨ë‹ˆí„°ë§ê³¼ í”¼ë“œë°± ì²´ê³„ê°€ ì§€ì†ë˜ë©´ ì‹ ë¢° ìœ ì§€ì— ë„ì›€ì´ ë  ìˆ˜ ìˆë‹¤."
]

scale_map = {
    "ì „í˜€ ë™ì˜í•˜ì§€ ì•ŠìŒ": 1,
    "ë™ì˜í•˜ì§€ ì•ŠìŒ": 2,
    "ë³´í†µì´ë‹¤": 3,
    "ë™ì˜í•¨": 4,
    "ë§¤ìš° ë™ì˜í•¨": 5
}
scale_labels = list(scale_map.keys())

with tabs[0]:
    st.markdown("#### ì•„ë˜ ë¬¸í•­ì— ì‘ë‹µí•´ ì£¼ì„¸ìš”.")
    responses = {}
    with st.form(key="likert_form"):
        for idx, stmt in enumerate(statements, 1):
            response = st.radio(f"{idx}. {stmt}", options=scale_labels, key=f"stmt_{idx}")
            responses[f"Q{idx:02}"] = scale_map[response]
        submitted = st.form_submit_button("ì œì¶œí•˜ê¸°")

    if submitted:
        df_new = pd.DataFrame([responses])
        if os.path.exists(DATA_PATH):
            df_old = pd.read_csv(DATA_PATH)
            df_all = pd.concat([df_old, df_new], ignore_index=True)
        else:
            df_all = df_new
        df_all.to_csv(DATA_PATH, index=False)
        st.success("ì‘ë‹µì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")

with tabs[1]:
    if os.path.exists(DATA_PATH):
        df = pd.read_csv(DATA_PATH)
        st.subheader("ğŸ§  ì§„ì§œ PCQ ìš”ì¸ ë¶„ì„ (ì•ˆì „ ì²˜ë¦¬ í¬í•¨)")
        st.write(f"ì´ ì‘ë‹µ ìˆ˜: {len(df)}ëª…")

        if len(df) >= 5:
            st.write("âœ… ì§„ìˆ  ê°„ ìƒê´€í–‰ë ¬ ê¸°ë°˜ ìš”ì¸ ì¶”ì¶œ ì¤‘...")

            # ë°©ë²• 3: ì‘ì€ ë…¸ì´ì¦ˆ ì¶”ê°€ (Singular ë°©ì§€)
            df_noise = df + np.random.normal(0, 0.001, df.shape)

            # ìƒê´€í–‰ë ¬ í™•ì¸ ë° ì •ì¹™ì„± ê²€ì‚¬
            corr = df_noise.corr()
            if np.linalg.matrix_rank(corr) < corr.shape[0]:
                st.error("âš ï¸ ìƒê´€í–‰ë ¬ì´ íŠ¹ì´(singular)í•©ë‹ˆë‹¤. ì‘ë‹µ ìˆ˜ë¥¼ ëŠ˜ë ¤ì£¼ì„¸ìš”.")
            else:
                fa = FactorAnalyzer(rotation='varimax')
                fa.fit(df_noise)
                ev, _ = fa.get_eigenvalues()

                st.write("ğŸ“Œ ê³ ìœ ê°’ (Eigenvalues):")
                st.bar_chart(ev)

                n_factors = st.slider("ì¶”ì¶œí•  ìš”ì¸ ìˆ˜", 1, min(6, len(df.columns)-1), 2)

                fa = FactorAnalyzer(n_factors=n_factors, rotation='varimax')
                fa.fit(df_noise)
                loadings = pd.DataFrame(
                    fa.loadings_,
                    index=[f"Q{idx+1}" for idx in range(len(df.columns))],
                    columns=[f"ìš”ì¸{i+1}" for i in range(n_factors)]
                )

                st.write("ğŸ“ˆ ìš”ì¸ ë¶€í•˜ í–‰ë ¬ (ì§„ìˆ  ê¸°ì¤€):")
                st.dataframe(loadings.style.background_gradient(axis=0, cmap='YlGnBu'))

                st.write("ğŸ“Œ ìš”ì¸ë³„ ëŒ€í‘œ ì§„ìˆ :")
                for col in loadings.columns:
                    top = loadings[col].abs().idxmax()
                    st.markdown(f"- **{col}**: ëŒ€í‘œ ì§„ìˆ  â†’ {top}")
        else:
            st.warning("ìš”ì¸ ë¶„ì„ì„ ìœ„í•´ ìµœì†Œ 5ëª…ì˜ ì‘ë‹µì´ í•„ìš”í•©ë‹ˆë‹¤.")
    else:
        st.info("ì•„ì§ ì €ì¥ëœ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.")
        
with tabs[2]:
    if os.path.exists(DATA_PATH):
        df = pd.read_csv(DATA_PATH)
        st.subheader("ğŸ” cross-statement feedback network")

        if len(df) >= 5:
            corr = df.corr()  # ì§„ìˆ  ê°„ ìƒê´€ê³„ìˆ˜ í–‰ë ¬
            G = nx.Graph()

            # ì§„ìˆ  ë…¸ë“œ ì¶”ê°€
            for i in range(len(statements)):
                G.add_node(f"Q{i+1}", label=statements[i])

            # ìƒê´€ê³„ìˆ˜ ê¸°ë°˜ ì—£ì§€ ìƒì„±
            for i in range(len(df.columns)):
                for j in range(i+1, len(df.columns)):
                    weight = corr.iloc[i, j]
                    if abs(weight) > 0.6:  # ê°•í•œ ìƒê´€ë§Œ í”¼ë“œë°± ì—°ê²°ë¡œ ê°„ì£¼
                        G.add_edge(f"Q{i+1}", f"Q{j+1}", weight=round(weight, 2))

            pos = nx.spring_layout(G, seed=42)
            plt.figure(figsize=(13, 10))
            nx.draw_networkx_nodes(G, pos, node_color='lightblue', node_size=700)
            nx.draw_networkx_labels(G, pos, labels=nx.get_node_attributes(G, 'label'), font_size=8)
            edges = G.edges(data=True)
            nx.draw_networkx_edges(G, pos, edgelist=edges, width=1)
            nx.draw_networkx_edge_labels(G, pos,
                edge_labels={(u, v): f"{d['weight']}" for u, v, d in edges},
                font_size=7)
            plt.title("cross-statement correlation feedback network ")
            st.pyplot(plt)
        else:
            st.warning("í”¼ë“œë°± êµ¬ì¡° ì‹œê°í™”ë¥¼ ìœ„í•´ ìµœì†Œ 5ëª…ì˜ ì‘ë‹µì´ í•„ìš”í•©ë‹ˆë‹¤.")
    else:
        st.info("ì‘ë‹µ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")

